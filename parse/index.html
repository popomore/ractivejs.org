<!doctype html>
<html lang='en-GB'>
<head>
	<meta charset='utf-8'>
	<title>Ractive.parse()</title>

	<!-- CSS -->
	<link rel='stylesheet' href='../lib/Divvy.css'>
	
	<link rel='stylesheet' href='../min.css'>
	<link rel='stylesheet' href='css/main.css'>
</head>

<body>
	<div class='header'>
		<h1>Ractive.parse()</h1>
	</div>

	<div id='container'></div>


	<!-- TEMPLATES -->
	<script id='main' type='text/ractive'>
		<div id='input' class='block'>
			<div class='options'>
				<label><input type='checkbox' checked='{{preserveWhitespace}}'>Preserve whitespace</label>
				<label><input type='checkbox' checked='{{sanitize}}'>Sanitize HTML</label>
			</div>
			
			<textarea value='{{input}}' placeholder='Paste in your template'></textarea>
		</div>
			
		<div id='output' class='block'>
			<div class='options'>
				<label><input type='checkbox' checked='{{indent}}'>Indent output</label>
			</div>

			<textarea value='{{( stringify( parsed, indent ) )}}' placeholder='JSON will appear here' readonly></textarea>
		</div>
		
		<div id='explorer' class='block'>
			{{#f.length}}
				<ul class='root' intro='fadeIn' outro='fadeOut'>
					{{#f}}
						{{>item}}
					{{/f}}
				</ul>
			{{/f.length}}
		</div>
	</script>

	<!--<script id='fragment' type='text/ractive'>
		<ul class='fragment'>
			{{#f}}
				{{>item}}
			{{/f}}
		</ul>
	</script>-->

	<script id='item' type='text/ractive'>
		<li class='item'>
			<h3>{{( label(.) )}}</h3>

			<!-- element -->
			{{#.a}}
				<div class='children hidden'>
					<h4 proxy-tap='toggle'>attributes</h4>
					<ul>
					{{#( toArray( . ) )}}
						<li class='item'><span>{{.name}}: {{.value}}</span></li>
					{{/()}}
					</ul>
				</div>
			{{/.a}}

			<!-- items with children -->
			{{#.f.length}}
				<div class='children hidden'>
					<h4 proxy-tap='toggle'>children</h4>
					<ul>
						{{#.f}}
							{{>item}}
						{{/.f}}
					</ul>
				</div>
			{{/.f.length}}
		</li>
	</script>

	<!-- JS -->
	<script src='../lib/Ractive.js'></script>
	<script src='../lib/Divvy.js'></script>

	<script>
		var ractive, stringifyExpression;


		stringifyExpression = function ( expr ) {
			return expr.s.replace( /‚ùñ([0-9]+)/g, function ( match, $1 ) {
				return expr.r[ $1 ];
			});
		};

		window.addEventListener( 'load', function () {
			ractive = new Ractive({
				el: 'container',
				template: '#main',
				lazy: true,
				debug: true,
				data: {
					indent: true,
					stringify: function ( parsed, indent ) {
						if ( !parsed ) {
							return '';
						}

						return JSON.stringify( parsed, null, indent ? '  ' : '' );
					},
					toArray: function ( obj ) {
						var arr = [], name;

						for ( name in obj ) {
							if ( obj.hasOwnProperty( name ) ) {
								arr[ arr.length ] = {
									name: name,
									value: obj[ name ]
								};
							}
						}

						return arr;
					},
					label: function ( item ) {
						var ch, result;

						switch ( item.t ) {
							case 1:
							result = '"' + item.s + '"';
							break;

							case 2:
							if ( item.r ) {
								result = '{{' + item.r + '}}';
							} else {
								result = '{{(' + stringifyExpression( item.x ) + ')}}';
							}
							break;

							case 3:
							if ( item.r ) {
								result = '{{{' + item.r + '}}}';
							} else {
								result = '[expression]';
							}
							break;

							case 4:
							ch = item.n ? '^' : '#';
							if ( item.r ) {
								result = '{{' + ch + item.r + '}}';
							} else {
								result = '[expression]';
							}
							break;

							case 7:
							result = '<' + item.e + '>';
							break;

							case 8:
							result = '{{>' + item.r + '}}';
							break;

							default:
							console.log( item );
							result = '"' + item + '"';
							//throw 'WTF?';
						}

						return result;
					}
				}
			});

			ractive.observe( 'input', function ( input ) {
				var parsed;

				if ( !input ) {
					return '';
				}

				parsed = Ractive.parse( input );
			
				ractive.set({
					parsed: parsed,
					f: parsed
				});
			});

			ractive.on( 'toggle', function ( event ) {
				var container, ul;

				container = event.node.parentNode;
				ul = container.querySelector( 'ul' );

				if ( container.classList.contains( 'visible' ) ) {
					container.classList.remove( 'visible' );
					container.classList.add( 'hidden' );
				} else {
					container.classList.remove( 'hidden' );
					container.classList.add( 'visible' );
				}
			});


			divvy = new Divvy({
				el: document.getElementById( 'container' ),
				columns: [
					[ 'input', 'output' ],
					'explorer'
				]
			});
		});
	</script>
</body>
</html>